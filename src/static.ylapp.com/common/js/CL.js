/**
 * CL.js——JavaScript下的MVC开发框架
 * Version: 1.0.0
 *  Author: 陆楚良
 *   Email: lu_chuliang@sina.com
 *      QQ: 874449204
 *
 * https://git.oschina.net/luchg/cl.js
 */
!function(t){"use strict";function e(t,e,r){if(r=r||t,l(t)&&Array.prototype.forEach)t.forEach(function(t,a){e.call(r,a,t)});else{var a;for(a in t)e.call(r,a,t[a])}}function r(t){for(var e,r,a=1,s=arguments.length;s>a;a++){e=arguments[a];for(r in e)t[r]=e[r]}return t}function a(t,e,r){var a=t.constructor,s=t.initialize;a!==e&&a.apply(t,r),n(s)&&s.apply(t,r)}var s={version:"1.0.0"},o=function(t){var e=t.toLowerCase();return function(r){return null==r?String(r)===e:"object"==typeof r||"function"==typeof r?{}.toString.call(r)==="[object "+t+"]":typeof r===e}},n=o("Function"),c=o("Object"),l=o("Array"),i=o("String");s.$={},s.Event=function(e){function r(t,e){t&&n(e.callback)&&(s[t]||(s[t]=[]),s[t].push(e))}function a(e){var r,a,o,n,c=0;if(e.event){if(o=s[e.event]){for(n=[];c<o.length;c++)a=o[c],(e.callback!==t&&e.callback!==a.callback||e.other!==t&&e.other!==a.other)&&n.push(a);s[e.event]=n}}else for(r in s){for(o=s[r],n=[];c<o.length;c++)a=o[c],(e.callback!==t&&e.callback!==a.callback||e.other!==t&&e.other!==a.other)&&n.push(a);s[r]=n}}var s,o={};return e=e||o,s={},o.on=function(t,a,s){t=t.split(" ");for(var o=0;o<t.length;o++)r(t[o],{callback:a,on:1,context:s||e,other:this})},o.once=function(t,a,s){t=t.split(" ");for(var o=0;o<t.length;o++)r(t[o],{callback:a,on:1,context:s||e,other:this})},o.off=function(t,e){t=t.split(" ");for(var r=0;r<t.length;r++)a({event:t[r],callback:e,other:this})},o.listenTo=function(t,e,r){t.on.call(o,e,r)},o.listenToOnce=function(t,e,r){t.once.call(o,e,r)},o.stopListening=function(t,e,r){t?t.off.call(o,e,r):o.off(e,r)},o.trigger=function(t){for(var e,r,a,n,c,l,i=t.split(" "),u=[].slice.call(arguments),f=!0,p=0,g=i.length;g>p;p++){if(t=i[p],e=u[p+1]||[],s[t]){for(a=[].slice.call(s[t]),n=a.length,c=[],r=0;n>r;r++)l=a[r],l.callback.apply(l.context,e)===!1&&(f=!1),l.on&&c.push(l);s[t]=c}"all"!==t&&(o.trigger("all",[t].concat(e))||(f=!1))}return f},o},s.Model=function(){a(this,s.Model,[].slice.call(arguments))},s.View=function(){a(this,s.View,[].slice.call(arguments))},s.Controller=function(){a(this,s.Controller,[].slice.call(arguments))},s.Model.extend=function(t){var e,s=function(){a(this,s,[].slice.call(arguments))};return s.extend=this.extend,s.parent=this,e=r(s.prototype,this.prototype,t),e.constructor===s&&(e.constructor=this.prototype.constructor),s},s.View.extend=function(t){var e,s=function(){a(this,s,[].slice.call(arguments))};return s.extend=this.extend,s.parent=this,e=r(s.prototype,this.prototype,t),e.constructor===s&&(e.constructor=this.prototype.constructor),s},s.Controller.extend=function(t){var e,s=function(){a(this,s,[].slice.call(arguments))};return s.extend=this.extend,s.parent=this,e=r(s.prototype,this.prototype,t),e.constructor===s&&(e.constructor=this.prototype.constructor),s},s.Model.prototype={constructor:function(a){var o=this;c(a)&&e(a,function(t){o[t]=a[t]}),o.attributes={},o.defaults&&e(n(o.defaults)?o.defaults():r({},o.defaults),function(e,r){r!==t&&(o.attributes[e]=r)}),o.Event=s.Event(this)},get:function(e){return this.has(e)?this.attributes[e]:t},escape:function(t){return escape(this.get(t))},has:function(t){return this.attributes.hasOwnProperty(t)},set:function(e,r){var a,s;if(c(e))for(a in e)this.set(a,e[a]);else r===t?this.del(e):(s=this.attributes[e],(s!==r||c(r)||l(r))&&(this.attributes[e]=r,this.Event.trigger("change change:"+e,[e,r,s],[r,s])));return this},del:function(){var r=this;return arguments.length>0?e([].slice.call(arguments),function(e,a){if(r.has(a)){var s;s=r.attributes[a],delete r.attributes[a],r.Event.trigger("change change:"+a,[a,t,s],[t,s])}}):r.clear(),r},clear:function(){var t;for(t in this.attributes)this.del(t);return this},reset:function(){var t,a=this;return a.defaults?(t=n(a.defaults)?a.defaults():r({},a.defaults),arguments.length>0?e([].slice.call(arguments),function(e,r){a.has(r)&&(t.hasOwnProperty(r)?a.set(r,t[r]):a.del(r))}):e(r({},a.attributes),function(e){t.hasOwnProperty(e)?a.set(e,t[e]):a.del(e)}),a):a.clear()},toJSON:function(){return JSON.parse(JSON.stringify(this.attributes))},save:function(t,e,a){if(e=i(e)?e.toLowerCase():"local",i(t)){var o,c=this,l=JSON.stringify(this.attributes);switch(e){case"server":return s.$.ajax&&(n(a)&&(a={callback:a}),a=a?r({},a):{},a.name=a.name||"data",a.data=a.data?r({},a.data):{},a.type=a.type||"post",a.dataType=a.dataType||"json",a.parseData=a.parseData||function(t){return{status:!0,data:t}},a.data[a.name]=l,s.$.ajax({url:t,data:a.data,type:a.type,dataType:a.dataType,error:function(t,e){c.Event.trigger("error error:save",["save",t,e],[t,e]),c.Event.trigger("save:error",["server",t,e]),a.callback&&a.callback.call(c,!1,t,e)},success:function(t){var e=a.parseData.call(c,t),r=e.data;e.status?(c.Event.trigger("success success:save",["save",r],[r]),c.Event.trigger("save:success",["server",r]),a.callback&&a.callback.call(c,!0,r)):this.error(this.xhr,"error")}})),!1;case"session":"object"==typeof sessionStorage&&null!==sessionStorage&&(o=sessionStorage);break;case"local":default:"object"==typeof localStorage&&null!==localStorage&&(o=localStorage)}if(o)return o[t]=JSON.stringify(c.attributes),c.Event.trigger("save:success",["session"==e?"session":"local"]),!0}return c.Event.trigger("save:error",["session"==e?"session":"local"]),!1},load:function(t,e,a){var o,c,l,u;if(e=i(e)?e.toLowerCase():"local",i(t)){switch(c=this,e){case"server":return s.$.ajax&&(n(a)&&(a={callback:a}),a=a?r({},a):{},a.data=a.data?r({},a.data):{},a.type=a.type||"post",a.dataType=a.dataType||"json",a.parseData=a.parseData||function(t){return{status:!0,data:t}},s.$.ajax({url:t,data:a.data,type:a.type,dataType:a.dataType,error:function(t,e){c.Event.trigger("error error:load",["load","",t,e],["",t,e]),c.Event.trigger("load:error",["server","",t,e]),a.callback&&a.callback.call(c,!1,t,e)},success:function(t){var e=a.parseData.call(c,t),s=e.data;e.status?(c.set(r({},c.attributes,s)),c.Event.trigger("success success:load",["load",s],[s]),c.Event.trigger("load:success",["server",s]),a.callback&&a.callback.call(c,!0,s)):this.error(this.xhr,"error")}})),!1;case"session":"object"==typeof sessionStorage&&null!==sessionStorage&&(o=sessionStorage);break;case"local":default:"object"==typeof localStorage&&null!==localStorage&&(o=localStorage)}if(o)try{if(l=o[t])return u=JSON.parse(l),c.set(r({},c.attributes,u)),c.Event.trigger("load:success",["session"==e?"session":"local"]),!0}catch(f){}}return c.Event.trigger("load:error",["session"==e?"session":"local"]),!1},destroy:function(t,e,a){if(e=i(e)?e.toLowerCase():"local",i(t)){var o,c=this;switch(e){case"server":return s.$.ajax&&(n(a)&&(a={callback:a}),a=a?r({},a):{},a.data=a.data?r({},a.data):{},a.type=a.type||"post",a.dataType=a.dataType||"json",a.parseData=a.parseData||function(t){return{status:!0,data:t}},s.$.ajax({url:t,data:a.data,type:a.type,dataType:a.dataType,error:function(t,e){c.Event.trigger("error error:destroy",["destroy",t,e],[t,e]),c.Event.trigger("destroy:error",["server",t,e]),a.callback&&a.callback.call(c,!1,t,e)},success:function(t){var e=a.parseData.call(c,t),r=e.data;e.status?(c.Event.trigger("success success:destroy",["destroy",r],[r]),c.Event.trigger("destroy:success",["server",r]),a.callback&&a.callback.call(c,!0,r)):this.error(this.xhr,"error")}})),!1;case"session":"object"==typeof sessionStorage&&null!==sessionStorage&&(o=sessionStorage);break;case"local":default:"object"==typeof localStorage&&null!==localStorage&&(o=localStorage)}if(o)return o.removeItem(t),c.Event.trigger("destroy:success",["session"==e?"session":"local"]),!0}return c.Event.trigger("destroy:error",["session"==e?"session":"local"]),!1}},s.View.prototype={constructor:function(t){if(c(t)){var e;for(e in t)this[e]=t[e]}},Template:function(e,r){return e.replace(/\$\{(.+?)\}/g,function(e,a){var s=r;return a.replace(/\[ *\"(.+?)\" *\]|\[ *\'(.+?)\' *\]|\.? *([0-9a-zA-Z_]+)/g,function(e,r,a,o){s!==t?s=s[r||a||o]:s+=e}),s})}},s.Controller.prototype={constructor:function(t){if(c(t)){var e;for(e in t)this[e]=t[e]}}},"function"==typeof define?define(function(){return s}):"undefined"!=typeof exports?module.exports=s:window.CL=s}();