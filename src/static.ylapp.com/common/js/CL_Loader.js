/**
 * 动态加载引擎
 * Author: 陆楚良
 * Version: 1.2.3
 * Date: 2015/09/10
 * QQ: 874449204
 *
 * https://git.oschina.net/luchg/CL_Loader.js.git
 *
 * License: http://www.apache.org/licenses/LICENSE-2.0
 */
!function(e,t){"use strict";function n(){var e=[],t=!0,n=null,r=this;r.queue=function(n){return e.push(n),t&&r.dequeue(),r},r.dequeue=function(){var r=r,a=e.shift();return t=!1,a?(clearTimeout(n),n=setTimeout(function(){"function"==u.type(a)&&a.call(r)},10)):t=!0,r}}function r(){var e=this;e.__files__=[],e.__package__=[],e.__queue__=!0,e.__cache__=!0,e.__charset__=null,e.__delay__=0}var a=function(){return h.run.apply(new r,[].slice.call(arguments))};a.version="1.2.3";var u=function(){var e,t={},n="Boolean Number String Function Array Date RegExp Object Error".split(" ");for(e=0;9>e;e++)t["[object "+n[e]+"]"]=n[e].toLowerCase();var r=function(e){return null==e?String(e):"object"==typeof e||"function"==typeof e?t[t.toString.call(e)]||"object":typeof e},a=function(e){return function(t){return r(t)==e}};return{type:r,Str:a("string"),Fun:a("function"),Obj:a("object"),Arr:a("array")}}(),c=t.head||t.getElementsByTagName("head")[0]||t.documentElement,s=c.getElementsByTagName("base")[0],o=+navigator.userAgent.replace(/.*(?:AppleWebKit|AndroidWebKit)\/(\d+).*/,"$1")<536,i=function(){var t=[],n=u.Obj(e.console)?e.console:{};return u.Fun(n.error)||(n.error=function(e){t.push("error:"+e)}),n}(),l=function(e,t){for(var n=0;n<e.length;n++)t.call(e,e[n],n)},f={getAbsPath:function(e){return function(t){return e.href=t,e.hasAttribute?e.href:e.getAttribute("href",4)}}(t.createElement("a")),cache:{},compile:function(e,t,r,a){if(e.type=u.Str(e.type)?e.type.toLowerCase():null,"js"!=e.type&&"css"!=e.type||!e.url||!u.Str(e.url))return void a(e);e.charset=e.charset||t,"css"==e.type?e.cache=!0:"boolean"!==u.type(e.cache)&&(e.cache=r);var c,s=f.getAbsPath(e.url),o=f.cache[s];return e.cache!==!1&&o?void o.queue(function(){a(),o.dequeue()}):(o||(c=f.cache[s]=(new n).queue(!0)),void f.loadResource(e,function(){c&&c.dequeue(),a()}))},loadResource:function(e,n){var r,a="css"==e.type,l=u.Str(e.charset)?e.charset:null,r=t.createElement(a?"link":"script");a?(r.rel="stylesheet",r.href=e.url):(r.async=!0,r.src=e.url),l&&(r.charset=l);var d="onload"in r,h=function(){r.onload=r.onreadystatechange=null,a||c.removeChild(r),r=null,n(e)};!a||!o&&d?d?(r.onload=h,r.onerror=function(){i.error("文件加载失败："+e.url),h()}):r.onreadystatechange=function(){/loaded|complete/.test(r.readyState)&&h()}:setTimeout(function(){f.pollCss(r,h)},0),s?c.insertBefore(r,s):c.appendChild(r)},pollCss:function(e,t){var n,r=e.sheet;if(o)r&&(n=!0);else if(r)try{r.cssRules&&(n=!0)}catch(a){"NS_ERROR_DOM_SECURITY_ERR"===a.name&&(n=!0)}n?t():setTimeout(function(){f.pollCss(e,t)},100)},start:function(e,t,r,a,u){var c=e.length;if(!c)return void u();if(r===!1)l(e,function(e){f.compile(e,t,a,function(){c-=1,0>=c&&u()})});else{var s=new n;l(e,function(e){s.queue(function(){f.compile(e,t,a,function(){c-=1,0>=c&&u(),s.dequeue()})})})}}},d=function(){var r=(new n).queue(!0),a=!1,u=function(){t.addEventListener?(t.removeEventListener("DOMContentLoaded",c,!1),e.removeEventListener("load",c,!1)):(t.detachEvent("onreadystatechange",c),e.detachEvent("onload",c))},c=function(){(t.addEventListener||"load"===event.type||"complete"===t.readyState)&&(u(),s())},s=function(){a||(a=!0,r.dequeue())};return function(){if("complete"===t.readyState)setTimeout(s,0);else if(t.addEventListener)t.addEventListener("DOMContentLoaded",c,!1),e.addEventListener("load",c,!1);else{t.attachEvent("onreadystatechange",c),e.attachEvent("onload",c);var n=!1;try{n=null==e.frameElement&&t.documentElement}catch(r){}n&&n.doScroll&&!function o(){if(!a){try{n.doScroll("left")}catch(e){return setTimeout(o,50)}u(),s()}}()}}(),function(e){r.queue(function(){e(),r.dequeue()})}}(),h=r.prototype={charset:function(e){return this.__charset__=e,this},queue:function(e){return this.__queue__=e,this},delay:function(e){return this.__delay__=e,this},cache:function(e){return this.__cache__=e,this}};h.add=function(){{var e=this;[].slice.call(arguments)}return l([].slice.call(arguments),function(t){if(u.Arr(t))h.add.apply(e,t);else{var n;if(u.Str(t))n={type:"css"==t.replace(/[\?#].*/,"").split(/\./).pop().toLowerCase()?"css":"js",url:t};else if(u.Obj(t)&&t.url&&u.Str(t.url)){var r=u.Str(t.type)?t.type.toLowerCase():0;"js"!=r&&"css"!=r&&(r="css"==t.url.replace(/[\?#].*/,"").split(/\./).pop().toLowerCase()?"css":"js"),n={type:r,url:t.url,charset:t.charset,cache:t.cache}}n&&e.__files__.push(n)}}),e},h.css=function(){var e=this;return l([].slice.call(arguments),function(t){u.Str(t)?e.add({type:"css",url:t}):u.Obj(t)&&u.Str(t.url)&&e.add({type:"css",url:t.url,charset:t.charset,cache:!0})}),e},h.js=function(){var e=this;return l([].slice.call(arguments),function(t){u.Str(t)?e.add({type:"js",url:t}):u.Obj(t)&&u.Str(t.url)&&e.add({type:"js",url:t.url,charset:t.charset,cache:t.cache})}),e},h.style=function(e){var n=t.getElementById("CL-Loader-inline-css");return n||(n=t.createElement("style"),n.type="text/css",n.id="CL-Loader-inline-css",t.getElementsByTagName("head")[0].appendChild(n)),n.styleSheet?n.styleSheet.cssText=n.styleSheet.cssText+e:n.appendChild(t.createTextNode(e)),this},h.use=function(){var e=this;return l([].slice.call(arguments),function(t){u.Str(t)?e.__package__.push(t):u.Arr(t)&&h.use.apply(e,t)}),e},h.run=function(){for(var e=this,t=function(){},n=[].slice.call(arguments),r=0;r<n.length;r++)switch(u.type(n[r])){case"object":case"string":e.add(n[r]);break;case"number":e.delay(n[r]);break;case"boolean":e.queue(n[r]);break;case"function":t=n[r]}"number"==u.type(e.__delay__)?setTimeout(function(){_(e,t)},e.__delay__):_(e,t)},h.ready=function(){var e=this,t=[].slice.call(arguments);d(function(){h.run.apply(e,t)})};var _=function(e,t){if(e.__package__.length>0){var a=new n;l(e.__package__,function(e){if(u.Str(e)){var t=p.hasOwnProperty(e)?p[e]:!1;t?a.queue(function(){u.Fun(t.onbefore)&&t.onbefore(),(new r).use(t.require).add(t.files).charset(t.charset).queue(t.queue).cache(t.cache).run(function(){a.dequeue(),u.Fun(t.onafter)&&t.onafter()})}):i.error("模块名“"+e+"”未定义！")}else i.error("模块名不合法："+u.type(e)+"不为string")}),a.queue(function(){f.start(e.__files__,e.__charset__,e.__queue__,e.__cache__,t),a.dequeue()})}else f.start(e.__files__,e.__charset__,e.__queue__,e.__cache__,t)};l(["add","css","js","use","charset","queue","style","delay","ready","run"],function(e){a[e]=function(){return h[e].apply(new r,[].slice.call(arguments))}});var p={};a.define=function(e){if(arguments.length>1)for(var t=[].slice.call(arguments),n=0;n<t.length;n++)a.define(t[n]);if(u.Str(e))return p.hasOwnProperty(e);if(!u.Obj(e)||!u.Str(e.name)||this.define(e.name))return!1;var r={status:"",Q:null};switch(p[e.name]=r,u.type(e.files)){case"string":case"object":case"array":r.files=e.files;break;default:r.files=[]}var c=e.require||e.rely;switch(u.type(c)){case"string":case"array":r.require=e.require;break;default:r.require=null}return e.queue===!1&&(r.queue=e.queue),e.cache===!1&&(r.cache=e.cache),e.charset&&(r.charset=e.charset),u.Fun(e.onbefore)&&(r.onbefore=e.onbefore),u.Fun(e.onafter)&&(r.onafter=e.onafter),e.auto&&this.use(e.name).ready(),!0},"function"==typeof define?define(function(){return a}):"undefined"!=typeof exports?module.exports=a:e.CL_Loader=e.Loader=e.L=a}(window,document);