/**
 * 众划算详情页功能js
 * Author: 陆楚良
 * Date: 2015/01/08
 * QQ: 519998338
 */
shs.detail=function(t,e,n,i,a,s,r){var o={};o.note=function(t){return n.dialog({lock:!0,fixed:!0,title:"温馨提示",content:t})},o.tips=function(t,e,i,a,s){var r;switch(s.toUpperCase()){case"E":r="error";break;case"S":r="succeed";break;case"Q":r="question";break;case"w":r="warning";break;case"FSD":r="face-sad";break;case"FSE":r="face-smile";break;default:r=null}return n.dialog({title:!1,cancel:!1,fixed:!0,lock:!0,icon:r||null,init:i||null,close:a||null}).content('<div style="padding: 0 1em;">'+t+"</div>").time(e||1)},o.not_bind_mobile=function(){n.dialog({lock:!0,fixed:!0,title:"温馨提示",content:'<p style="color:#FF3300;font-weight: bold;font-size:16px;">抢购失败</p><p>您还未认证手机号码，暂时无法抢购。请认证手机号码以后再次尝试！^o^</p><div style="margin-top:20px;" class="f-tac"><a href="'+i.site("buyer")+'bind/mobile" target="_blank" class="u-btn u-btn-cr" style="padding: 0.4em 1.3em;">马上去认证</a></div>',init:function(){var t=this;t.DOM.content.find("a").click(function(){t.title("认证结果").content('<p>请在新打开的界面完成认证 , 是否认证成功 ?</p><div style="margin-top:20px;" class="f-tac"><a href="javascript:;" class="u-btn u-btn-cr J_continue" style="padding: 0.4em 1.8em;margin-right: 20px;">认证成功</a><a href="'+i.site("help")+'buyer/category/95/100/249" target="_blank" class="u-btn">认证遇到问题</a></div>'),t.DOM.content.find(".J_continue").click(function(){t.close(),location.reload()})})}})},o.UserBuyLog=function(){return"function"!=e.type(f.__tourists__)};var l={},c={},u={can_buy:!1,buy_err:"",buy_verify:null,buy_posting:!1,is_buy:!1,buy_oid:null},d="z-buy-dis",_=i.user.info(),f={__tourists__:function(){},all_order_num:"0",wait_fill_num:"0",check_failure_num:"0",wait_rebate_num:"0",appeal_num:"0",rebate_num:"0",wait_check_num:"0",order_num:0,season_no:0,need_mobile_valid:!1,mobile_valid:2,is_captcha:0},m=function(){var t=!1;return function(){if(!t){if(t=!0,"object"!=e.type(a))return alert("无法读取此商品信息！"),location.href=i.site("www"),!1;var n=Time.clock(),s=Number(a.nowtime);if(setInterval(function(){a.nowtime=s+n()},1e3),l.mInfo=e("#J_mInfo"),l.btn_buy=l.mInfo.find(".J_btn_buy"),l.countdown_tt=l.mInfo.find(".J_countdown dt"),l.countdown_ct=l.mInfo.find(".J_countdown dd"),l.number=l.mInfo.find(".J_number"),l.verify=l.mInfo.find(".J_verify"),e("#J_PV").html(a.hits),l.mInfo.find(".J_bond").html(a.paid_guaranty),l.mInfo.find(".J_cost_price").html(a.cost_price),l.mInfo.find(".J_price").html(a.price),l.mInfo.find(".J_single_rebate").html(a.single_rebate),l.mInfo.find(".J_search_reward").html(a.search_reward),l.mInfo.find(".J_discount").html(a.discount),!function(t){var e=t("#J_gallery"),n=e.find(".J_pic"),i=e.find(".J_thumb li");i.each(function(e){if(0==e)t(this).data("img",n.find("img"));else{var i=t(this).find("img");t(this).data("img",t("<img/>").attr("src",i.data("src")).attr("alt",i.attr("alt")))}}),i.hover(function(){i.filter(".z-sel").removeClass("z-sel"),t(this).addClass("z-hover z-sel"),n.html("").append(t(this).data("img"))},function(){t(this).removeClass("z-hover")}),i.find("a").click(function(){return!1})}(e),e("#J_notice").tab({eType:"mouseover",card:".J_menu a",panel:".J_panel ul",curClass:"z-crt"}),!function(t){var e=t("#J_tuijian"),n=e.find(".J_change"),i=e.find(".J_bd").children();i.hide().slice(0,3).show();var a=0,s=1,r=i.length;n.click(function(){s&&(s=1,a=r>a+3?a+3:0,i.filter(":visible").fadeOut(function(){i.slice(a,a+3).fadeIn(function(){s=1})}))})}(e),!function(t){var e=function(t,e){if(1==e)return"";var n='<div class="m-page f-tac">';t>1&&(n+='<a href="javascript:;" class="prev" data-page="'+(t-1)+'"><span class="arrow">&nbsp;</span>上一页</a>');var i,a=[];if(8>e||5>t)for(i=1;(8>e?e:7)>=i;i++)a.push(i);else for(i=t-3;t+3>=i;i++)a.push(i);for(a.length>=7&&a[0]>2&&(a=[1,3==a[0]?2:"..."].concat(a)),a.length>=7&&a[a.length-1]<e-1&&(a=a.concat([a[a.length-1]==e-2?e-1:"...",e])),i=0;i<a.length;i++)n+="..."==a[i]?"<i>...</i>":'<a href="javascript:;"'+(a[i]==t?' class="z-crt"':"")+' data-page="'+a[i]+'">'+a[i]+"</a>";return t!=e&&(n+='<a href="javascript:;" class="next" data-page="'+(t+1)+'">下一页<span class="arrow">&nbsp;</span></a>'),n+="<span>共 "+e+" 页</span></div>"},n=function(t){for(var e='<div class="deal f-cb">',n=0;n<t.length;n++)e+='<a href="http://bbs.shikee.com/space-uid-'+t[n].uid+'.html" target="_blank">'+(t[n].is_refund?'<i class="u-icon u-icon-s">&nbsp;</i>':"")+'<img src="'+t[n].avatar+'"/><span>'+t[n].uname+"</span></a>";return e+="</div>"},i=function(t){for(var e='<ul class="report-item f-cb">',n=0;n<t.length;n++)e+='<li><a href="http://bbs.shikee.com/yesvalue.php?mod=showshop&amp;uid='+t[n].uid+"&amp;showshopid="+t[n].id+'" target="_blank" class="report-pic"><img src="'+t[n].img_url+'"></a><div class="report-bd"><div class="f-cb"><a href="http://bbs.shikee.com/space-uid-'+t[n].uid+'.html" class="report-userFace" target="_blank"><img src="'+t[n].avatar+'"></a><a class="report-userName" href="http://bbs.shikee.com/space-uid-'+t[n].uid+'.html" target="_blank">'+t[n].uname+'</a><p class="report-date">'+t[n].posttime+'</p></div><div class="report-ct">'+t[n].words+"</div></div></li>";return e+="</ul>"},s=t("#J_dealtab"),r={deal:s.find(".J_deal"),report:s.find(".J_report"),dealMenu:s.find(".J_menu a").eq(0),reportMenu:s.find(".J_menu a").eq(1)};return{init:function(){s.tab({eType:"click",card:".J_menu a",panel:".J_panel",curClass:"z-crt"}),r.dealMenu.html("谁抢到了("+a.fill_order_num+")"),a.fill_order_num>0?this.deal_show(1):r.deal.html("<p>暂无数据。</p>");var t=this;r.reportMenu.html("买家晒单("+a.show_num+")").one("click",function(){a.show_num>0?t.report_show(1):r.report.html("<p>暂时无人晒单~</p>")})},deal_show:function(i){var s=this;r.deal.html("<p>正在加载...</p>"),t.post("/buyer/"+a.gid+"/"+i,function(i){if(i.total>0){var a=t(n(i.list)),o=t(e(i.page.now,i.page.total));o.find("a[data-page]").click(function(){t(this).hasClass(".z-crt")||s.deal_show(t(this).data("page"))}),r.deal.html(a.add(o))}else r.deal.html("<p>暂无数据。</p>")},"json")},report_show:function(n){var s=this;r.report.html("<p>正在加载...</p>"),t.post("/show/"+a.gid+"/"+n,function(n){if(n.total>0){var a=t(i(n.rows)),o=t(e(n.page.now,n.page.total));o.find("a[data-page]").click(function(){t(this).hasClass(".z-crt")||s.deal_show(t(this).data("page"))}),r.report.html(a.add(o))}else r.report.html("<p>暂时无人晒单~</p>")},"json")}}}(e).init(),document.getElementById("bdshell_js").src="http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion="+Math.ceil(new Date/36e5),_){var r=i.site("detail")+"user-data-";r+=1==_.type?"buyer?gid="+a.gid+"&callback=?":"seller?callback=?",e.getJSON(r,function(t){if(!t.error){if(1==_.type){var n=i.site("buyer");e("#J_notice").replaceWith('<div class="m-log"><h4 class="tt">我的订单提醒</h4><ul class="ct"><li><a target="_blank" href="'+n+'order/?s=1">待填写订单号:<em>'+t.wait_fill_num+'</em></a></li><li><a target="_blank" href="'+n+'order/?s=5">订单号有误:<em>'+t.check_failure_num+'</em></a></li><li><a target="_blank" href="'+n+'order/?s=3">待审核订单号:<em>'+t.wait_check_num+'</em></a></li><li><a target="_blank" href="'+n+'order/?s=4">待返现:<em>'+t.wait_rebate_num+'</em></a></li><li><a target="_blank" href="'+n+'order/?s=6">申诉中:<em>'+t.appeal_num+'</em></a></li></ul><p class="f-tac"><a href="'+n+'" target="_blank" class="u-btn">个人中心</a></p></div>')}else if(2==_.type){var n=i.site("seller");e("#J_notice").replaceWith('<div class="m-log"><h4 class="tt">我的活动管理</h4><ul class="ct"><li><a target="_blank" href="'+n+'goods/goods_list?state=-1">所有活动:<em>'+t.goods_num+'</em></a></li><li><a target="_blank" href="'+n+'goods/goods_list?state=20">正在进行中:<em>'+t.online_num+'</em></a></li><li><a target="_blank" href="'+n+'goods/goods_list?state=21">已屏蔽活动:<em>'+t.block_num+'</em></a></li><li><a target="_blank" href="'+n+'goods/goods_list?state=22">已下架活动:<em>'+t.offline_num+'</em></a></li><li><a target="_blank" href="'+n+'goods/goods_list?state=31">结算中活动:<em>'+t.balancing_sum+'</em></a></li></ul><p class="f-tac"><a href="'+n+'" target="_blank" class="u-btn">个人中心</a></p></div>')}f=t,u.is_buy&&(f.season_no=a.season_no),h.init()}})}l.btn_buy.click(function(){return h.buy(),!1})}}}(),p={};p.S_3=function(){l.btn_buy.html("已支付待审核"),l.countdown_tt.html("活动时间"),l.countdown_ct.html(Time.converter("{%d天}{%h时}{%i分}{%s秒}",1e3*a.first_days))},p.S_5=function(){l.btn_buy.html("即将上线"),a.expect_online_time-a.nowtime>=3600?(l.countdown_tt.html("开抢时间"),l.countdown_ct.html(Time.strftime("%M月%D日 %H:%I",1e3*a.expect_online_time)),c.count_down=setInterval(function(){a.expect_online_time-a.nowtime<3600&&(clearInterval(c.count_down),h.init())})):(l.countdown_tt.html("开抢倒计时"),c.count_down=setInterval(function(){return a.starttime-a.nowtime<=0?(clearInterval(c.count_down),a.state=20,a.season_no=Number(a.season_no)+1,a.endtime=a.nowtime+a.first_days,void h.init()):void l.countdown_ct.html(Time.converter("{%d天}{%h时}{%i分}{%s秒}",1e3*(a.starttime-a.nowtime)))},1e3),l.countdown_ct.html(Time.converter("{%d天}{%h时}{%i分}{%s秒}",1e3*(a.starttime-a.nowtime))))},p.S_20=function(){if(l.btn_buy.removeClass(d).html("我要抢购"),u.can_buy=!0,l.countdown_tt.html("剩余时间"),a.endtime-a.nowtime>0&&(c.count_down=setInterval(function(){return a.endtime-a.nowtime<=0?(clearInterval(c.count_down),l.countdown_ct.html("-"),void t.location.reload()):void l.countdown_ct.html(Time.converter("{%d天}{%h时}{%i分}{%s秒}",1e3*(a.endtime-a.nowtime)))},1e3),l.countdown_ct.html(Time.converter("{%d天}{%h时}{%i分}{%s秒}",1e3*(a.endtime-a.nowtime)))),_&&1==_.type){var n=Number(a.season_no)>Number(f.season_no),s=Number(f.order_num)<Number(a.buy_limit),r=n&&s;if(r||(l.btn_buy.addClass(d),u.can_buy=!1),n||(l.btn_buy.html("抢购成功"),u.buy_err="众划算商品名额有限，同一抢购时间段，同一款商品一个会员只有一次抢购机会，再看看其它众划算商品吧！"),s||(u.buy_err='抱歉，该商品限制最多可以抢购<em class="s-fc-hh">'+a.buy_limit+"</em>次，再看看其它众划算商品吧！"),r&&f.is_captcha){if(l.verify.data("is_draw")!==!0){l.verify.data("is_draw",!0);var o='<img data-src="'+i.site("detail")+"home/get_code/"+a.gid+'" width="120" height="30" alt="点击刷新验证码" title="点击更换验证码"/><span>验证码：</span><input class="u-ipt J_captcha" maxlength="12" type="text" /><span class="tip J_tip">&nbsp;</span>';l.verify.html(o).show(),l.verify.find("img").click(function(){e(this).attr("src",e(this).data("src")+"?"+Math.floor(1e9*Math.random()))}).click(),u.buy_verify=function(t){var n="string"==e.type(t)?t.length:0;return 0==n?"验证码不能为空":4>n||n>6?"验证码错误":!0},l.verify.find(".J_captcha").on("keyup blur",function(){var t=u.buy_verify(this.value);l.verify.find(".J_tip").html(t!==!0?t:"&nbsp;")})}}else l.verify.hide()}},p.S_24=function(){l.btn_buy.html("还有机会"),l.number.html("<span>限量份数：<strong>"+a.quantity+"</strong> 份</span><span>未下单人数：<strong>"+a.wait_fill_num+"</strong> 份</span>")},p.S_Other=function(){var t={1:"未付款待审核",2:"待审核付款中",4:"发布修改退款中",10:"取消退款中",11:"已取消",12:"审核未通过退款中",13:"审核未通过",21:"已屏蔽",22:"活动结束"};return function(n){"string"==e.type(t[n])&&l.btn_buy.html(t[n])}}();var h={};return h.init=function(){return m()!==!1?(function(t,n){for(n in t)t.hasOwnProperty(n)&&"number"==e.type(t[n])&&clearInterval(t[n])}(c),l.countdown_ct.html("-"),l.number.html("<span>限量份数：<strong>"+a.quantity+'</strong> 份</span><span>剩余份数：<strong class="s-fc-hh">'+a.remain_quantity+"</strong> 份</span>"),l.btn_buy.addClass(d).html("活动结束").show(),u.can_buy=!1,u.buy_err="","function"==e.type(p["S_"+a.state])?p["S_"+a.state].call(this):p.S_Other.call(this,a.state),u.buy_posting&&l.btn_buy.html("抢购中.."),this):void 0},h.buy=function(){if(!u.can_buy||u.buy_posting||u.is_buy)return void(u.buy_err&&o.tips(u.buy_err,2,null,null,"e"));if(!_)return void i.user.login();if(1!=_.type)return void o.note('<p>很抱歉，众划算商品抢购暂时只限买家参与，建议您注册买家帐号进行抢购！</p><div style="margin-top:20px;" class="f-tac"><a href="'+i.site("login")+'logout/" class="u-btn u-btn-cr" style="margin-right:20px;">买家登录</a><a href="'+i.site("reg")+'buyer/" class="u-btn u-btn-cr">买家注册</a></div>');var t="";if(o.UserBuyLog()){if(f.is_captcha&&(t=l.verify.find(".J_captcha").val(),"function"==e.type(u.buy_verify))){var c=u.buy_verify(t);if(c!==!0)return void o.tips(c,2,null,function(){l.verify.find(".J_captcha").focus()},"e")}if(f.need_mobile_valid&&2==f.mobile_valid)return void o.not_bind_mobile()}u.buy_posting=!0,l.btn_buy.html("抢购中.."),e.jsonp({url:i.site("trade")+"?gid="+a.gid+(t?"&specialValiCode="+t:"")+"&"+r.token+"&callback=?",error:function(t,e){u.buy_posting=!1,l.btn_buy.html("我要抢购"),"timeout"==e?o.tips("系统连接超时，请稍后重试。",2,null,null,"e"):o.tips("系统繁忙，请稍后重试！",2,null,null,"e")},success:function(t){if(u.buy_posting=!1,l.btn_buy.html("我要抢购"),t.success)u.is_buy=!0,u.buy_oid=t.new_oid,f.order_num=Number(f.order_num)+1,f.season_no=a.season_no,h.init(),n.dialog({lock:!0,fixed:!0,title:"抢购成功",content:'<div class="m-buySuc"><div class="f-cb"><h5 class="tt">√ 抢购成功，请确认以下优惠哦！</h5><a class="f-fr" href="'+i.site("help")+'buyer/category/1/5/178" target="_blank" title="下单遇到问题">下单遇到问题？</a></div><div class="ct f-cb"><p>请注意以下事项：</p><p>1、此为“<em class="s-fc-hh">搜索下单</em>”活动，请按照活动页面提示流程进行搜索下单。<a target="_blank" href="'+s.what_is_search_buy_help+'">什么是搜索下单</a></p><p>2、网购价：<em class="s-fc-hh">'+s.price+'</em>元，请在下单页面核对网购价是否一致。</p><p>3、返现金额：<em class="s-fc-hh">'+a.single_rebate+'</em>，完成交易后，将返还给您的返现金额。</p><p>注意：报名抢购后<em class="s-fc-hh">'+a.auto_clear_time_min+'分钟内</em>不下单付款和返回<em class="s-fc-hh">填写订单号</em>，本次报名记录将自动取消。</p></div></div>',cancel:!0,cancelVal:"继续抢购，稍后再去下单",okVal:"抢购成功，现在马上去搜索下单",ok:function(){h.save_no()}});else switch(t.info.errcode){case"BUY_REPEAT":o.tips("众划算商品名额有限，同一抢购时间段，同一款商品每个会员只有一次抢购机会，再看看其它众划算商品吧！",2,null,function(){f.season_no=a.season_no,h.init()},"e");break;case"CAPTCHA_ERROR":o.tips("验证码错误",2,null,function(){l.verify.find(".J_captcha").focus()},"e");break;case"NOT_CAPTCHA":o.tips("请输入验证码",2,null,function(){o.UserBuyLog()?(f.is_captcha=1,h.init(),l.verify.find(".J_captcha").focus()):location.reload()},"e");break;case"WITHOUT_MOBILE_VALID":o.not_bind_mobile();break;default:o.tips(t.info.errtxt,2,null,null,"e")}}})},h.save_no=function(){if(u.buy_oid){var l=u.buy_oid,c='<form><table><colgroup><col style="width:60px"><col style="width:350px"></colgroup><tbody style="color:#797979;"><tr><td>商品名称：</td><td style="color: #06f">'+s.title+'</td></tr><tr><td>网购价：</td><td style="font-weight:bold;color:#000;">￥'+a.price+'</td></tr><tr><td>订单编号：</td><td><input type="text" name="trade_no" class="u-ipt J_trade_no" /><span class="J_tradeTip" style="color: #cc0000;"></span></td></tr><tr class="J_verify" style="display:none"><td>验证码：</td><td style="padding: 4px 0;"><img class="J_codeImg" data-src="'+i.site("buyer")+"order/get_code/"+l+'" src="" alt="验证码" title="点击刷新验证码" style="cursor:pointer" /><input type="text" class="u-ipt J_code" name="vcode" style="width:8em;" /><span class="J_codeTip" style="color: #cc0000;">&nbsp;</span></td></tr><tr><td style="vertical-align: top;">温馨提示：</td><td style="color:#999;"><p>1、请填写已付款的订单编号，若填入未付款单号，属于违规行为且将无法获得返现；<a style="color:#09f;" href="'+i.site("help")+'buyer/category/66/125/16" target="_blank">填写的订单号规则？</a></p><p>2、若单号被审核有误，请在 '+r.order_auto_close_time_hour+' 小时内进行申诉或修改，逾期将无法领回返现金额（建议平时经常登录网站查看站内信提醒哦！）<a style="color:#09f;display:block;" href="'+s.get_order_number_help+'" target="_blank">如何获取订单编号？</a></p></td></tr></tbody></table><input type="submit" style="display:none"/></form>';n.dialog({fixed:!0,title:"填写单号",content:c,init:function(){var r=this,c=this.DOM.content.find("form"),u=c.find(".J_verify"),d=c.find(".J_trade_no"),_=c.find(".J_tradeTip"),f=c.find(".J_code"),m=c.find(".J_codeTip"),p=c.find(".J_codeImg");p.click(function(){this.src=p.attr("data-src")+"?"+Math.floor(1e9*Math.random())}),d.focus(),c.submit(function(){var c=e.trim(d.val()),h=f.val(),b={trade_no:c};if(m.html(""),_.html(""),""==c)return _.html(" 请输入订单号"),!1;if(/[^\-0-9a-zA-Z]/.test(c))return d.val(""),_.html(" 订单号有误"),!1;if(_.html(""),u.is(":visible")){if(!e.trim(h))return m.html(" 验证码错误"),p.click(),f.focus(),!1;m.html(""),b.is_captcha=1,b.vcode=h}return d.prop("disabled",!0),f.prop("disabled",!0),_.css("color","#666").html(" 正在发送..."),r.DOM.buttons.find("button:first").html("操作中...").attr("disabled","disabled").removeClass("aui_state_highlight"),e.jsonp({url:i.site("buyer")+"order/save_no/"+a.gid+"/"+l,data:b,callbackParameter:"callback",success:function(e){if(e.success)n.dialog({fixed:!0,icon:"succeed",time:5,title:"填写单号成功",content:"单号填写成功！",ok:!0}),r.close(),t._hmt&&t._hmt.push(["_trackOrder",{orderId:l,orderTotal:a.price,item:[{skuId:a.gid,skuName:s.title,category:"未知",Price:a.price,Quantity:1}]}]);else{switch(_.css("color","#c00").html(""),u.is(":visible")&&p.click()&&f.val("").focus(),e.data){case"NO_BIND_TAOBAO":_.html('未认证手机号码，<a href="'+i.site("buyer")+'bind/mobile" target="_blank" style="color:#0066FF">现在去认证</a>');break;case"CAPTCHA_IS_NULL":case"CAPTCHA_ERROR":m.html("CAPTCHA_ERROR"==e.data?"验证码错误！":"请输入验证码！"),u.is(":visible")||(u.show(),p.click(),f.focus());break;case"TRADE_NO_IS_NULL":case"TRADE_NO_ERROR":_.html("TRADE_NO_ERROR"==e.data?"订单号格式有误！":"请填写订单号！"),d.val("").focus();break;default:_.html(e.data),d.val("")}d.prop("disabled",!1),f.prop("disabled",!1),r.DOM.buttons.find("button:first").html("确定").addClass("aui_state_highlight").prop("disabled",!1),t.open(i.site("buyer")+"order/")}},error:function(e,n){"timeout"==n?o.tips("系统连接超时，请稍后重试。",2,null,function(){t.open(i.site("buyer")+"order/")},"e"):o.tips("系统繁忙，请稍后重试！",2,null,function(){t.open(i.site("buyer")+"order/")},"e")}}),!1})},ok:function(){return this.DOM.content.find("form").submit(),!1}})}},h.init()}(window,$,art,shs,goods,goods_info,Global);