/**
 * 表单验证插件
 * Author: 陆楚良
 * Version: 2.0.1
 * Date: 2014/02/07
 * QQ: 519998338
 *
 * https://git.oschina.net/luchg/jquery.CL_Valitator.js.git
 *
 * License: http://www.apache.org/licenses/LICENSE-2.0
 */
!function(n,c){if(window.Queue==c)return void(console&&console.error("缺少Queue队列引擎！"));var e="cl_valitator_config",o="cl_valitator_config_id",r=function(n){var c,e;for(e=0,c=0;c<n.length;c++)e+=n.charCodeAt(c)>=0&&n.charCodeAt(c)<=255?1:2;return e},t={require:/\S+/,email:/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,url:/^http(s?):\/\/(?:[A-za-z0-9-]+\.)+[A-za-z]{2,4}(?:[\/\?#][\/=\?%\-&~`@[\]\':+!\.#\w]*)?$/,currency:/^(0|[1-9][0-9]*)(\.[0-9]{1,2})?$/,number:/^\d+$/,zip:/^\d{6}$/,integer:/^(0|-?[1-9][0-9]*)$/,pinteger:/^(0|[1-9][0-9]*)$/,"double":/^-?(0|[1-9][0-9]*)\.[0-9]+$/,pdouble:/^(0|[1-9][0-9]*)\.[0-9]+$/,english:/^[A-Za-z]+$/,chinese:/^[\u4e00-\u9fa5]+$/},l=function(c){return"object"==n.type(c)},a=function(c){return"array"==n.type(c)},u=function(c){return"string"==n.type(c)},s=function(c){return"number"==n.type(c)},i=function(c){return"function"==n.type(c)},f=function(c){return"regexp"==n.type(c)},h=function(){var n=0;return function(){return n++}}();n.fn.CL_Valitator=function(d,v){return i(d)?this.each(function(){var c=n(this).data(e);n.each(c._func,function(n,c){c.focus.call(c.self),c.blur.call(c.self,d)})}):i(v)?this.each(function(){var r=n(this).data(e);n(this).find(d).each(function(){var e=n(this).data(o);r._func[e]&&(r._func[e].focus.call(this),r._func[e].blur.call(this,c,v))})}):u(v)?this.each(function(){var c=this,r=n(this).data(e);n(this).find(d).each(function(){var e=this,t=n(this).data(o),l=r._dict[t];l&&(l._lock=!0,i(l.onerror)&&l.onerror.call(e,v),i(r.onerror)&&r.onerror.call(e,v),i(l.onlock)&&l.onlock.call(e),i(r.onlock)&&r.onlock.call(c))})}):v===c?(d=n.extend({onerror:null,onsuccess:null,onlock:null,onunlock:null,onfocus:null},l(d)?d:{}),this.each(function(){var c=n(this),o=n.extend({},d);o._lock=!1,o._dict={},o._func={},c.data(e,o),l(o.rules)&&n.each(o.rules,function(n,e){c.CL_Valitator(n,e)})})):this.each(function(){var c=this,_=n(c);l(_.data(e))||_.CL_Valitator({});var k=_.data(e);_.find(d).each(function(){var d,g=this,b=n(g),p=(n.inArray(g,k._dict),b.data(o));switch(n.type(v)){case"array":d=s(p)?k._dict[p]:{},d.rules=v;break;case"object":d=n.extend(s(p)?k._dict[p]:{},v),d.rules=a(d.rules)?d.rules:[];break;case"null":d={rules:[],_lock:!1}}if(d){if(s(p))k._dict[p]=d;else{var m=h();b.data(o,m),k._dict[m]=d}var w,y=d.rules,$=[],A=d.success||null,C=d.error||null;for(w=0;w<y.length;w++)switch(y[w].type.toLowerCase()){case"regexp":$[$.length]=function(n){var c=u(n.action)?t[n.action.toLowerCase()]:n.action,e=n.match===!1?!1:!0;return function(o){f(c)&&c.test(b.val())==e?o(n,!0,n.success||A):o(n,!1,n.error||C)}}(y[w]);break;case"length":$[$.length]=function(n){var c=n.action;return function(e){var o=n.lengthAt?r(b.val()):b.val().length;o>=c[0]&&o<=c[1]?e(n,!0,n.success||A):e(n,!1,n.error||C)}}(y[w]);break;case"minlength":$[$.length]=function(n){return function(c){var e=n.lengthAt?r(b.val()):b.val().length;e>=n.action?c(n,!0,n.success||A):c(n,!1,n.error||C)}}(y[w]);break;case"maxlength":$[$.length]=function(n){return function(c){var e=n.lengthAt?r(b.val()):b.val().length;e<=n.action?c(n,!0,n.success||A):c(n,!1,n.error||C)}}(y[w]);break;case"callback":$[$.length]=function(n){return function(c){n.action.call(g,b.val(),function(e,o){e?c(n,!0,o||n.success||A):c(n,!1,o||n.error||C)})}}(y[w]);break;case"ajax":$[$.length]=function(c){var e=n.param(c.data||{});return function(o){i(c.onbefore)&&c.onbefore.call(g),n.ajax({url:c.action,data:e+"&"+(c.name||b.attr("name"))+"="+encodeURIComponent(b.val()),type:c.method||"get",error:function(){o(c,!1,c.net_error)},success:function(e){i(c.oncomplete)?c.oncomplete.call(g,e,function(n,e){n?o(c,!0,e||c.success||A):o(c,!1,e||c.error||C)}):"TRUE"==n.trim(e).toUpperCase()?o(c,!0,c.success||A):o(c,!1,c.error||C)}})}}(y[w])}if(d._f=$,!s(p)){var x=new Queue;k._func[m]={self:g,focus:function(){var n=_.data(e);if(l(n)){var r=n._dict[b.data(o)];r&&(x.clear(),r._lock=!0,i(r.onlock)&&r.onlock.call(g),i(n.onlock)&&n.onlock.call(c),i(r.onfocus)&&r.onfocus.call(g),i(n.onfocus)&&n.onfocus.call(g))}},blur:function(r,t){var a=_.data(e);if(l(a)){var u=a._dict[b.data(o)];if(u){x.clear();var s=null,f=function(){if(i(a.onunlock)||i(r)){var e=!0;n.each(a._dict,function(n,c){c._lock!==!1&&(e=!1)}),e&&(i(a.onunlock)&&a.onunlock.call(c),i(r)&&r.call(c))}};if(0==u._f.length)i(u.onsuccess)&&u.onsuccess.call(g,s),i(a.onsuccess)&&a.onsuccess.call(g,s),u._lock=!1,i(u.onunlock)&&u.onunlock.call(g),i(t)&&t.callback(g),f();else for(var h=0;h<u._f.length;h++)!function(n){x.queue(function(){u._f[n](function(e,o,r){o?(s=r||s,i(e.onsuccess)&&e.onsuccess.call(g,r),n==u._f.length-1&&(i(u.onsuccess)&&u.onsuccess.call(g,s),i(a.onsuccess)&&a.onsuccess.call(g,s),u._lock=!1,i(u.onunlock)&&u.onunlock.call(g),f()),x.dequeue()):(x.clear(),i(e.onerror)&&e.onerror.call(g,r),i(u.onerror)&&u.onerror.call(g,r),i(a.onerror)&&a.onerror.call(g,r),i(u.onlock)&&u.onlock.call(g),i(a.onlock)&&a.onlock.call(c))})})}(h)}}}},b.focus(k._func[m].focus).blur(k._func[m].blur)}0==$.length&&b.blur()}})}),this}}(jQuery);